# エニグマ設計

## 1. JSON設定データ構造設計

###   1.1 設定ファイル形式
```json
{
    "name": "daily_setting_001",
    "rotors": [
      {
        "type": "I",
        "position": "A",
        "ring_setting": 1
      },
      {
        "type": "II",
        "position": "B",
        "ring_setting": 1
      },
      {
        "type": "III",
        "position": "C",
        "ring_setting": 1
      }
    ],
    "reflector": "B",
    "plugboard": ["AB", "CD", "EF", "GH", "IJ"]
  }
```

### 1.2 設定項目詳細

  - name: 設定の識別名（文字列、省略可能）
  - rotors: ローター設定配列（必須、3個または4個）
    - type: ローター種別（"I", "II", "III", "IV", "V"）
    - position: 初期位置（"A"-"Z"の1文字）
    - ring_setting: リング設定（1-26の整数）
  - reflector: リフレクター種別（"B"または"C"）
  - plugboard: プラグ設定配列（0-13個の2文字文字列）
  

### 1.3 設定読み込み処理
  1. JSONファイルの構文解析
  2. 必須フィールドの存在確認
  3. 各設定値の範囲・形式検証
  4. ローター種別の重複チェック
  5. プラグボード設定の整合性確認


### 1.4 設定保存処理
  1. 現在の設定状態を取得
  2. JSON形式への変換
  3. ファイルへの書き込み
  4. 書き込み結果の検証


## 2. エニグママシン本体設計

### 2.1 基本データ構造
```go
  type EnigmaMachine struct {
      rotors    []*Rotor     // ローター配列（3個または4個）
      reflector *Reflector   // リフレクター
      plugboard *Plugboard   // プラグボード
      config    *Config      // 現在の設定
      isReady   bool         // 初期化完了フラグ
  }
```

### 2.2 設定管理構造
```go
  type Config struct {
      Name      string        // 設定名
      Rotors    []RotorConfig // ローター設定配列
      Reflector string        // リフレクター種別
      Plugboard []string      // プラグ設定
  }
```

```go
  type RotorConfig struct {
      Type        string // ローター種別
      Position    string // 初期位置
      RingSetting int    // リング設定
  }
```

### 2.3 初期化処理設計

  1. 設定検証: 入力設定の妥当性確認
  2. コンポーネント作成: ローター、リフレクター、プラグボードの生成
  3. 相互関係設定: コンポーネント間の連携設定
  4. 初期状態確立: 暗号化可能状態への移行


### 2.4 暗号化処理フロー
  1. 入力文字検証: A-Z範囲内かチェック
  2. プラグボード変換: 入力側変換実行
  3. ローター回転: 右端ローターの回転処理
  4. 順方向変換: 右から左へのローター変換
  5. リフレクター変換: 文字反射処理
  6. 逆方向変換: 左から右へのローター変換
  7. プラグボード変換: 出力側変換実行
  8. 結果文字出力: 暗号化結果の返却

## 3. プラグボード設計

### 3.1 基本データ構造
```go
type Plugboard struct {
      wiring [26]int      // 変換テーブル（A=0からZ=25）
      plugs  []string     // 設定されたプラグ一覧
  }
```

### 3.2 初期化処理設計

  1. 配列初期化: 全ての文字を自分自身にマッピング
  2. プラグ解析: 入力プラグ文字列の解析
  3. 双方向設定: ペア文字の相互マッピング設定
  4. 検証処理: 設定の整合性確認

### 3.3 変換処理設計

  - 入力: 0-25の整数（文字に対応）
  - 処理: 変換テーブルでの直接参照
  - 出力: 変換後の0-25の整数

### 3.4 設定変更処理設計

  1. プラグ追加: 新しいペア接続の追加
  2. プラグ削除: 既存ペア接続の削除
  3. 全クリア: 全プラグ接続の削除
  4. 一括設定: 全プラグの一括設定

## 4. ローター設計

### 4.1 基本データ構造
```go
  type Rotor struct {
      forwardWiring  [26]int // 順方向配線
      backwardWiring [26]int // 逆方向配線
      notchPosition  int     // ノッチ位置
      currentPos     int     // 現在位置
      ringSetting    int     // リング設定
      rotorType      string  // ローター種別
  }
```

### 4.2 配線パターン定数

  - ローターI-V: 各ローターの固有配線パターン
  - ノッチ位置: 各ローターの固有ノッチ位置
  - 逆配線計算: 順方向配線から自動算出

### 4.3 回転処理設計

  1. 位置更新: 現在位置を1つ進める
  2. 循環処理: 25の次は0に戻る
  3. ノッチ判定: ノッチ位置到達の判定
  4. 連鎖回転: 隣接ローターへの回転通知

### 4.4 変換処理設計

#### 順方向変換

  1. 入力位置調整: 現在位置とリング設定の考慮
  2. 配線変換: 配線テーブルでの文字変換
  3. 出力位置調整: 変換結果の位置補正

#### 逆方向変換

  1. 入力位置調整: 現在位置とリング設定の考慮
  2. 逆配線変換: 逆配線テーブルでの文字変換
  3. 出力位置調整: 変換結果の位置補正

## 5. リフレクター設計

### 5.1 基本データ構造
```go
  type Reflector struct {
      wiring        [26]int // 反射配線パターン
      reflectorType string  // リフレクター種別
  }
```

### 5.2 配線パターン定数

  - リフレクターB: 標準配線パターン
  - リフレクターC: 代替配線パターン
  - ペア関係: 各文字の反射先定義

### 5.3 変換処理設計

  - 入力: 0-25の整数
  - 処理: 配線テーブルでの直接参照
  - 出力: 反射後の0-25の整数

## 6. 関数処理方法設計

### 6.1 文字変換ユーティリティ

#### 文字→数値変換

  - 入力: A-Zの文字
  - 処理: ASCIIコードから65を減算
  - 出力: 0-25の整数

#### 数値→文字変換

  - 入力: 0-25の整数
  - 処理: 65を加算してASCII文字に変換
  - 出力: A-Zの文字

### 6.2 位置計算関数

#### 順方向位置計算

  調整位置 = (入力位置 + 現在位置 - リング設定 + 26) % 26

#### 逆方向位置計算

  調整位置 = (入力位置 - 現在位置 + リング設定 + 26) % 26

### 6.3 回転制御関数

#### 基本回転

  1. 現在位置を1増加
  2. 26で割った余りを新しい位置とする
  3. ノッチ位置との比較結果を返す

#### 連鎖回転

  1. 右端ローターの回転実行
  2. ノッチ到達時は中央ローターも回転
  3. ダブルステッピングの考慮

### 6.4 設定更新関数

#### 個別コンポーネント更新

  1. プラグボード更新: 新しいプラグ設定の適用
  2. ローター更新: 位置・リング設定の変更
  3. リフレクター更新: 種別変更

#### 全体設定更新

  1. 設定妥当性の検証
  2. 全コンポーネントの再初期化
  3. 新しい設定の適用

## 7. エラーハンドリング設計

### 7.1 エラー分類体系

#### 設定関連エラー

  - ErrInvalidRotorType: 無効なローター種別
  - ErrInvalidPosition: 無効な位置設定
  - ErrInvalidRingSetting: 無効なリング設定
  - ErrInvalidReflectorType: 無効なリフレクター種別
  - ErrInvalidPlugFormat: 無効なプラグ形式

#### 入力関連エラー

  - ErrInvalidCharacter: 無効な入力文字
  - ErrEmptyInput: 空の入力
  - ErrNullInput: NULL入力

#### 状態関連エラー

  - ErrNotInitialized: 未初期化状態
  - ErrInvalidState: 無効な内部状態

### 7.2 エラー処理戦略

#### エラー検出レベル

  1. 入力時検証: 関数呼び出し時の即座な検証
  2. 処理中検証: 処理過程での状態チェック
  3. 出力時検証: 結果の妥当性確認

#### エラー対応方針

  1. 早期検出: 可能な限り早い段階でのエラー検出
  2. 詳細情報: エラー原因の具体的な情報提供
  3. 安全停止: エラー時の安全な処理停止
  4. 状態保護: エラー発生時の内部状態保護

### 7.3 エラーメッセージ設計

#### 情報内容

  - エラー種別: 何のエラーかの明確な識別
  - 発生場所: どのコンポーネントで発生したか
  - 原因詳細: なぜエラーが発生したかの説明
  - 対処方法: エラー解決のための提案

#### メッセージ例

  - "無効なローター種別 'X' が指定されました。有効な種別は I, II, III, IV, V です。"
  - "プラグ設定 'ABC' は無効です。2文字で指定してください。"
  - "文字 '1' は無効です。A-Zの範囲で入力してください。"

### 7.4 エラー回復設計

#### 自動回復可能エラー

  - 設定値正規化: 範囲外の値を有効範囲に調整
  - 文字正規化: 小文字を大文字に自動変換

#### 手動回復必要エラー

  - 設定エラー: ユーザーによる設定修正が必要
  - データエラー: 入力データの修正が必要